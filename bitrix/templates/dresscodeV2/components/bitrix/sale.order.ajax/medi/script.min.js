BX.saleOrderAjax={BXCallAllowed:false,options:{},indexCache:{},controls:{},modes:{},properties:{},init:function(options){var ctx=this;this.options=options;window.submitFormProxy=BX.proxy(function(){ctx.submitFormProxy.apply(ctx,arguments)},this);BX(function(){ctx.initDeferredControl()});BX(function(){ctx.BXCallAllowed=true});this.controls.scope=BX("bx-soa-order");BX.bindDelegate(this.controls.scope,"click",{className:"-bx-popup-set-mode-add-loc"},function(){var input=BX.create("input",{attrs:{type:"hidden",name:"PERMANENT_MODE_STEPS",value:"1"}});BX.prepend(input,BX("bx-soa-order"));ctx.BXCallAllowed=false;BX.Sale.OrderAjaxComponent.sendRequest()})},cleanUp:function(){for(var k in this.properties){if(this.properties.hasOwnProperty(k)){if(typeof this.properties[k].input!="undefined"){BX.unbindAll(this.properties[k].input);this.properties[k].input=null}if(typeof this.properties[k].control!="undefined")BX.unbindAll(this.properties[k].control)}}this.properties={}},addPropertyDesc:function(desc){this.properties[desc.id]=desc.attributes;this.properties[desc.id].id=desc.id},initDeferredControl:function(){var ctx=this,k,row,input,locPropId,m,control,code,townInputFlag,adapter;if(typeof window.BX.locationsDeferred!="undefined"){this.BXCallAllowed=false;for(k in window.BX.locationsDeferred){window.BX.locationsDeferred[k].call(this);window.BX.locationsDeferred[k]=null;delete window.BX.locationsDeferred[k];this.properties[k].control=window.BX.locationSelectors[k];delete window.BX.locationSelectors[k]}}for(k in this.properties){if(this.properties[k].isZip){row=this.controls.scope.querySelector('[data-property-id-row="'+k+'"]');if(BX.type.isElementNode(row)){input=row.querySelector('input[type="text"]');if(BX.type.isElementNode(input)){this.properties[k].input=input;locPropId=false;for(m in this.properties){if(this.properties[m].type=="LOCATION"){locPropId=m;break}}if(locPropId!==false){BX.bindDebouncedChange(input,function(value){var zipChangedNode=BX("ZIP_PROPERTY_CHANGED");zipChangedNode&&(zipChangedNode.value="Y");input=null;row=null;if(BX.type.isNotEmptyString(value)&&/^\s*\d+\s*$/.test(value)&&value.length>3){ctx.getLocationsByZip(value,function(locationsData){ctx.properties[locPropId].control.setValueByLocationIds(locationsData)},function(){try{}catch(e){}})}})}}}}if(this.properties[k].type=="LOCATION"){if(typeof this.properties[k].control!="undefined"){control=this.properties[k].control;code=control.getSysCode();if(typeof this.properties[k].altLocationPropId!="undefined"){if(code=="sls"){control.replaceTemplate("nothing-found",this.options.messages.notFoundPrompt)}if(code=="slst"){(function(k,control){control.setOption("pseudoValues",["other"]);control.bindEvent("control-before-display-page",function(adapter){control=null;var parentValue=adapter.getParentValue();if(parentValue==this.getOption("rootNodeValue")||!this.checkCanSelectItem(parentValue))return;var controlInApater=adapter.getControl();if(typeof controlInApater.vars.cache.nodes["other"]=="undefined"){controlInApater.fillCache([{CODE:"other",DISPLAY:ctx.options.messages.otherLocation,IS_PARENT:false,VALUE:"other"}],{modifyOrigin:true,modifyOriginPosition:"prepend"})}});townInputFlag=BX("LOCATION_ALT_PROP_DISPLAY_MANUAL["+parseInt(k)+"]");control.bindEvent("after-select-real-value",function(){if(BX.type.isDomNode(townInputFlag))townInputFlag.value="0"});control.bindEvent("after-select-pseudo-value",function(){if(BX.type.isDomNode(townInputFlag))townInputFlag.value="1"});control.bindEvent("before-set-value",function(){if(BX.type.isDomNode(townInputFlag))townInputFlag.value="0"});if(BX.type.isDomNode(townInputFlag)&&townInputFlag.value=="1"){adapter=control.getAdapterAtPosition(control.getStackSize()-1);if(typeof adapter!="undefined"&&adapter!==null)adapter.setValuePair("other",ctx.options.messages.otherLocation)}})(k,control)}}}}}$zip=$("input[name='ORDER_PROP_6']").val();if($zip.length==10){$.ajax({url:"/ajax/order/",data:{action:"getLocation",lid:$zip},method:"POST",success:function(data){},failure:function(){}})}if($("input[name='ORDER_PROP_3']").length){var delFirstEight={onKeyPress:function(val,e,field,options){if(val.replace(/\D/g,"").length===2){val=val.replace("8","");field.val(val)}field.mask("79999999999",options)},placeholder:"+7 (___) ___-__-__"};$("input[name='ORDER_PROP_3']").mask("79999999999",delFirstEight)}$(".bx-soa-item-td a").on("click",function(){var pos=$(this).parents(".bx-soa-item-tr").data("pos");var productList="Список Оформление заказа";var product_id=$(this).data("id");$.ajax({url:"/ajax.php",dataType:"json",data:{act:"getItemData",product_id:product_id},success:function(data){window.dataLayer=window.dataLayer||[];data=data.DATA;dataLayer.push({ecommerce:{currencyCode:"RUB",click:{actionField:{list:productList},products:[{name:data.NAME,id:data.ID,price:data.PRICE,brand:data.BRAND,category:data.CATEGORY,variant:data.CML2_ARTICLE,position:pos}]}},event:"gtm-ee-event","gtm-ee-event-category":"Enhanced Ecommerce","gtm-ee-event-action":"Product Clicks","gtm-ee-event-non-interaction":"False"})}});return true});$(".pull-right.btn").on("click",function(){sect_id=$(this).parents(".bx-soa-section").attr("id").replace("bx-soa-","").replace("-hidden","");if(sect_id=="region")$page="/form-city";if(sect_id=="delivery")$page="/form-how-to-get";if(sect_id=="paysystem")$page="/form-how-to-pay";if(sect_id=="properties")$page="/form-name-telephone";ga("set","page",$page);ga("send","pageview",$page)});this.BXCallAllowed=true;if(BX.Sale.OrderAjaxComponent)BX.Sale.OrderAjaxComponent.locationsCompletion()},checkMode:function(propId,mode){if(mode=="altLocationChoosen"){if(this.checkAbility(propId,"canHaveAltLocation")){var input=this.getInputByPropId(this.properties[propId].altLocationPropId);var altPropId=this.properties[propId].altLocationPropId;if(input!==false&&input.value.length>0&&!input.disabled&&this.properties[altPropId].valueSource!="default"){return true}}}return false},checkAbility:function(propId,ability){if(typeof this.properties[propId]=="undefined")this.properties[propId]={};if(typeof this.properties[propId].abilities=="undefined")this.properties[propId].abilities={};if(typeof this.properties[propId].abilities!="undefined"&&this.properties[propId].abilities[ability])return true;if(ability=="canHaveAltLocation"){if(this.properties[propId].type=="LOCATION"){if(typeof this.properties[propId].altLocationPropId!="undefined"&&typeof this.properties[this.properties[propId].altLocationPropId]){var altLocPropId=this.properties[propId].altLocationPropId;if(typeof this.properties[propId].control!="undefined"&&this.properties[propId].control.getSysCode()=="slst"){if(this.getInputByPropId(altLocPropId)!==false){this.properties[propId].abilities[ability]=true;return true}}}}}return false},getInputByPropId:function(propId){if(typeof this.properties[propId].input!="undefined")return this.properties[propId].input;var row=this.getRowByPropId(propId);if(BX.type.isElementNode(row)){var input=row.querySelector('input[type="text"]');if(BX.type.isElementNode(input)){this.properties[propId].input=input;return input}}return false},getRowByPropId:function(propId){if(typeof this.properties[propId].row!="undefined")return this.properties[propId].row;var row=this.controls.scope.querySelector('[data-property-id-row="'+propId+'"]');if(BX.type.isElementNode(row)){this.properties[propId].row=row;return row}return false},getAltLocPropByRealLocProp:function(propId){if(typeof this.properties[propId].altLocationPropId!="undefined")return this.properties[this.properties[propId].altLocationPropId];return false},toggleProperty:function(propId,way,dontModifyRow){var prop=this.properties[propId];if(typeof prop.row=="undefined")prop.row=this.getRowByPropId(propId);if(typeof prop.input=="undefined")prop.input=this.getInputByPropId(propId);if(!way){if(!dontModifyRow)BX.hide(prop.row);prop.input.disabled=true}else{if(!dontModifyRow)BX.show(prop.row);prop.input.disabled=false}},submitFormProxy:function(item,control){var propId=false;for(var k in this.properties){if(typeof this.properties[k].control!="undefined"&&this.properties[k].control==control){propId=k;break}}if(item!="other"){if(this.BXCallAllowed){this.BXCallAllowed=false;setTimeout(function(){BX.Sale.OrderAjaxComponent.sendRequest()},20)}}},getPreviousAdapterSelectedNode:function(control,adapter){var index=adapter.getIndex();var prevAdapter=control.getAdapterAtPosition(index-1);if(typeof prevAdapter!=="undefined"&&prevAdapter!=null){var prevValue=prevAdapter.getControl().getValue();if(typeof prevValue!="undefined"){var node=control.getNodeByValue(prevValue);if(typeof node!="undefined")return node;return false}}return false},getLocationsByZip:function(value,successCallback,notFoundCallback){if(typeof this.indexCache[value]!="undefined"){successCallback.apply(this,[this.indexCache[value]]);return}var ctx=this;BX.ajax({url:this.options.source,method:"post",dataType:"json",async:true,processData:true,emulateOnload:true,start:true,data:{ACT:"GET_LOCS_BY_ZIP",ZIP:value},onsuccess:function(result){if(result.result){ctx.indexCache[value]=result.data;successCallback.apply(ctx,[result.data])}else{notFoundCallback.call(ctx)}},onfailure:function(type,e){}})}};